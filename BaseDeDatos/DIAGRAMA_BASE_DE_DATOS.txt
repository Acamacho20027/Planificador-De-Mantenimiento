╔═══════════════════════════════════════════════════════════════════════════════╗
║                   DIAGRAMA DE BASE DE DATOS                                   ║
║              PLANIFICADOR DE MANTENIMIENTO - SQL SERVER                       ║
╚═══════════════════════════════════════════════════════════════════════════════╝

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 ESTRUCTURA DE TABLAS Y RELACIONES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


┌─────────────────────────────────────────────────────────────────────────────┐
│                          SISTEMA DE USUARIOS                                 │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────┐
    │      👤 USUARIOS         │
    ├──────────────────────────┤
    │ PK  user_id (UUID)       │──┐
    │     email                │  │
    │     password_hash        │  │
    │     nombre               │  │
    │     rol                  │  │
    │     is_active            │  │
    │     failed_login_count   │  │
    │     lockout_until        │  │
    │     created_at           │  │
    │     updated_at           │  │
    └──────────────────────────┘  │
              │                    │
              │                    │
              ▼                    │
    ┌──────────────────────────┐  │
    │  🔐 PASSWORD_RESET_TOKENS│  │
    ├──────────────────────────┤  │
    │ PK  token_id (UUID)      │  │
    │ FK  user_id ─────────────│──┘
    │     token_hash           │
    │     expires_at           │
    │     used_at              │
    │     created_at           │
    └──────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                       SISTEMA DE TAREAS E INSPECCIONES                       │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────┐         ┌──────────────────────────┐
    │    🏷️  ESTADOS           │         │   📍 UBICACIONES         │
    ├──────────────────────────┤         ├──────────────────────────┤
    │ PK  id_estado            │──┐      │ PK  id_ubicacion         │
    │     codigo_estado        │  │      │     edificio             │
    │     nombre_estado        │  │      │     piso                 │
    │     color_hex            │  │      │     oficina_aula         │
    │     orden_display        │  │      │     codigo_ubicacion     │
    │     activo               │  │      │     descripcion          │
    └──────────────────────────┘  │      │     activa               │
                                   │      └──────────────────────────┘
                                   │
                                   │
    ┌──────────────────────────┐  │      ┌──────────────────────────┐
    │   🔍 INSPECCIONES        │  │      │      📋 TAREAS           │
    ├──────────────────────────┤  │      ├──────────────────────────┤
    │ PK  id_inspeccion        │──┼─────▶│ PK  id_tarea             │
    │     nombre_tarea         │  │      │ FK  id_estado ───────────│──┘
    │     edificio             │  │      │ FK  id_inspeccion        │
    │     piso                 │  │      │ FK  asignado_user_id ────│───┐
    │     oficina_aula         │  │      │ FK  creado_por ──────────│───┤
    │     prioridad            │  │      │                          │   │
    │     datos_completos(JSON)│  │      │     titulo               │   │
    │ FK  creado_por ──────────│──┼──┐   │     descripcion          │   │
    │     timestamp_inspeccion │  │  │   │     asignado_a           │   │
    │     fecha_creacion       │  │  │   │     fecha                │   │
    └──────────────────────────┘  │  │   │     fecha_inicio         │   │
                                   │  │   │     fecha_finalizacion   │   │
                                   │  │   │     inspeccion_data(JSON)│   │
                                   │  │   │     prioridad            │   │
                                   │  │   │     tiempo_estimado_min  │   │
                                   │  │   │     costo_estimado       │   │
                                   │  │   │     actualizado_por      │   │
                                   │  │   └──────────────────────────┘   │
                                   │  │              │                    │
                                   │  │              │                    │
                                   │  └──────────────┼────────────────────┼─┐
                                   │                 │                    │ │
                                   │                 ▼                    │ │
    ┌──────────────────────────┐  │   ┌──────────────────────────┐      │ │
    │    🖼️  IMAGENES          │  │   │  📜 HISTORIAL_ESTADOS    │      │ │
    ├──────────────────────────┤  │   ├──────────────────────────┤      │ │
    │ PK  id_imagen            │  │   │ PK  id_historial         │      │ │
    │ FK  id_tarea ────────────│──┼───│ FK  id_tarea ────────────│──────┘ │
    │ FK  subido_por ──────────│──┘   │ FK  estado_anterior      │        │
    │     nombre_archivo       │      │ FK  estado_nuevo         │        │
    │     tipo_mime            │      │ FK  cambiado_por ────────│────────┘
    │     data_base64          │      │     comentario           │
    │     tamaño_bytes         │      │     fecha_cambio         │
    │     tipo_imagen          │      └──────────────────────────┘
    │     descripcion          │
    │     fecha_subida         │
    └──────────────────────────┘


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔄 FLUJO DE DATOS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. CREACIÓN DE TAREA DESDE INSPECCIÓN
   ──────────────────────────────────

   Usuario completa wizard ──▶ Frontend envía datos JSON
                                        │
                                        ▼
                              Backend recibe inspección
                                        │
                      ┌─────────────────┴─────────────────┐
                      │                                   │
                      ▼                                   ▼
          Guardar en tabla              Crear tarea en tabla
          'inspecciones'                     'tareas'
          (datos_completos: JSON)       (referencia a inspección)
                      │                                   │
                      └─────────────────┬─────────────────┘
                                        │
                                        ▼
                          ¿Hay imágenes adjuntas?
                                    │
                          ┌─────────┴─────────┐
                          │                   │
                         SÍ                  NO
                          │                   │
                          ▼                   │
                  Guardar en tabla            │
                    'imagenes'                │
                  (base64 data URL)           │
                          │                   │
                          └─────────┬─────────┘
                                    │
                                    ▼
                          Trigger automático registra
                          cambio en 'historial_estados'


2. ACTUALIZACIÓN DE ESTADO
   ────────────────────────

   Usuario cambia estado ──▶ Frontend PUT /api/tasks/:id
                                        │
                                        ▼
                          Backend llama SP_actualizar_tarea
                                        │
                                        ▼
                              Actualizar en 'tareas'
                                        │
                                        ▼
                    Trigger TR_tareas_cambio_estado se activa
                                        │
                    ┌───────────────────┴───────────────────┐
                    │                                       │
                    ▼                                       ▼
        Insertar en                         Actualizar fechas automáticamente
      'historial_estados'                   (fecha_inicio si pasa a "en progreso")
                                            (fecha_fin si pasa a "finalizado")


3. AUTENTICACIÓN
   ─────────────

   Usuario introduce credenciales ──▶ Frontend POST /auth/login
                                                │
                                                ▼
                                    Backend llama SP_autenticar_usuario
                                                │
                                                ▼
                                      ¿Contraseña correcta?
                                                │
                            ┌───────────────────┴───────────────────┐
                            │                                       │
                           NO                                      SÍ
                            │                                       │
                            ▼                                       ▼
                SP_registrar_login_fallido          SP_limpiar_login_fallidos
                            │                                       │
                            ▼                                       ▼
                Incrementar failed_count            Resetear failed_count = 0
                Si >= 5: lockout_until              Actualizar ultimo_acceso
                        = +15 min                           │
                            │                               │
                            ▼                               ▼
                    Retornar error 401          Crear sesión y retornar OK


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔧 PROCEDIMIENTOS ALMACENADOS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────────────────────┬─────────────────────────────────────┐
│ Procedimiento                       │ Función                             │
├─────────────────────────────────────┼─────────────────────────────────────┤
│ SP_autenticar_usuario               │ Login: obtener datos del usuario    │
│ SP_registrar_login_fallido          │ Incrementar intentos fallidos       │
│ SP_limpiar_login_fallidos           │ Resetear tras login exitoso         │
│ SP_crear_tarea_desde_inspeccion     │ Crear nueva tarea                   │
│ SP_actualizar_tarea                 │ Actualizar estado/asignación        │
│ SP_obtener_tarea_por_id             │ Obtener tarea + imágenes            │
│ SP_obtener_todas_tareas             │ Listar todas las tareas             │
│ SP_obtener_stats_dashboard          │ Estadísticas para dashboard         │
└─────────────────────────────────────┴─────────────────────────────────────┘


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 VISTAS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────────────────────┬─────────────────────────────────────┐
│ Vista                               │ Uso                                 │
├─────────────────────────────────────┼─────────────────────────────────────┤
│ VW_tareas_completas                 │ Tareas con JOINS de todas las       │
│                                     │ tablas relacionadas (estados,       │
│                                     │ usuarios, inspecciones, etc.)       │
│                                     │                                     │
│ VW_estadisticas_estados             │ Conteos, promedios y totales por    │
│                                     │ cada estado de tareas               │
│                                     │                                     │
│ VW_dashboard_principal              │ Resumen general: totales de tareas, │
│                                     │ usuarios, inspecciones, costos      │
└─────────────────────────────────────┴─────────────────────────────────────┘


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔒 TRIGGERS (AUTOMÁTICOS)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────────────────────┬─────────────────────────────────────┐
│ Trigger                             │ Acción                              │
├─────────────────────────────────────┼─────────────────────────────────────┤
│ TR_usuarios_update                  │ Actualiza 'updated_at' en usuarios  │
│                                     │ cada vez que se modifica un registro│
│                                     │                                     │
│ TR_tareas_update                    │ Actualiza 'fecha_actualizacion' en  │
│                                     │ tareas tras cualquier UPDATE        │
│                                     │                                     │
│ TR_tareas_cambio_estado             │ Cuando cambia id_estado:            │
│                                     │ 1. Insertar en historial_estados    │
│                                     │ 2. Actualizar fecha_inicio si pasa  │
│                                     │    a 'in_progress'                  │
│                                     │ 3. Actualizar fecha_finalizacion    │
│                                     │    si pasa a 'done'                 │
└─────────────────────────────────────┴─────────────────────────────────────┘


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📝 TIPOS DE DATOS IMPORTANTES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

UNIQUEIDENTIFIER:
  - Usado para user_id (compatibilidad con UUID de Node.js)
  - Generado con NEWID() o desde el frontend

NVARCHAR(MAX):
  - Usado para campos JSON (datos_completos, inspeccion_data)
  - Usado para imágenes base64 (data_base64)
  - Permite almacenar textos muy largos

DATETIME2:
  - Mayor precisión que DATETIME
  - Usado para todos los timestamps

NVARCHAR vs VARCHAR:
  - NVARCHAR soporta Unicode (caracteres especiales, emojis, etc.)
  - Usado en todos los campos de texto


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 ÍNDICES CREADOS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Tabla: usuarios
  ├─ IX_usuarios_email (email)
  ├─ IX_usuarios_rol (rol)
  └─ IX_usuarios_is_active (is_active)

Tabla: password_reset_tokens
  ├─ IX_reset_tokens_user_id (user_id)
  └─ IX_reset_tokens_expires (expires_at)

Tabla: ubicaciones
  ├─ IX_ubicaciones_edificio (edificio)
  └─ IX_ubicaciones_piso (piso)

Tabla: inspecciones
  ├─ IX_inspecciones_prioridad (prioridad)
  ├─ IX_inspecciones_edificio (edificio)
  └─ IX_inspecciones_fecha (fecha_creacion)

Tabla: tareas
  ├─ IX_tareas_estado (id_estado)
  ├─ IX_tareas_asignado (asignado_user_id)
  ├─ IX_tareas_fecha (fecha)
  ├─ IX_tareas_prioridad (prioridad)
  └─ IX_tareas_creacion (fecha_creacion)

Tabla: imagenes
  ├─ IX_imagenes_tarea (id_tarea)
  └─ IX_imagenes_fecha (fecha_subida)

Tabla: historial_estados
  ├─ IX_historial_tarea (id_tarea)
  └─ IX_historial_fecha (fecha_cambio)


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💡 EJEMPLO DE CONSULTA COMPLETA
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

-- Obtener todas las tareas con información completa

SELECT 
    t.titulo,
    e.nombre_estado,
    u.nombre AS asignado_a,
    i.nombre_tarea AS inspeccion,
    t.fecha,
    t.prioridad,
    (SELECT COUNT(*) FROM imagenes WHERE id_tarea = t.id_tarea) AS total_imagenes,
    (SELECT TOP 1 comentario 
     FROM historial_estados 
     WHERE id_tarea = t.id_tarea 
     ORDER BY fecha_cambio DESC) AS ultimo_comentario
FROM tareas t
LEFT JOIN estados e ON t.id_estado = e.id_estado
LEFT JOIN usuarios u ON t.asignado_user_id = u.user_id
LEFT JOIN inspecciones i ON t.id_inspeccion = i.id_inspeccion
ORDER BY t.fecha_creacion DESC;


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Diagrama creado para: Planificador de Mantenimiento
Versión: 1.0
Fecha: Octubre 2025
Compatible con: SQL Server 2016+

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

