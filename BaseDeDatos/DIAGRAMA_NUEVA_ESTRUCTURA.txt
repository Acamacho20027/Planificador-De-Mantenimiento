╔═══════════════════════════════════════════════════════════════════════════════════════╗
║                    DIAGRAMA DE BASE DE DATOS - NUEVA ESTRUCTURA                       ║
║                      PLANIFICADOR DE MANTENIMIENTO V2.0                               ║
╚═══════════════════════════════════════════════════════════════════════════════════════╝

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 ESTRUCTURA DE TABLAS Y RELACIONES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


    ┌──────────────────────────┐
    │      🔑 ROLES            │
    ├──────────────────────────┤
    │ PK  id_rol               │──────┐
    │     nombre_rol           │      │
    │     descripcion          │      │
    │     fecha_creacion       │      │
    └──────────────────────────┘      │
                                      │
                                      │ 1:N
                                      │
    ┌──────────────────────────┐      │
    │     👤 USUARIOS           │      │
    ├──────────────────────────┤      │
    │ PK  id_usuario           │◄─────┘
    │     nombre               │
    │     email                │
    │     numero_telefono      │
    │     password_hash        │
    │ FK  id_rol               │
    │     activo               │
    │     fecha_creacion       │
    │     fecha_actualizacion  │
    │     ultimo_acceso        │
    └──────────────────────────┘
              │
              │ 1:N (creado_por)
              │
              ▼
    ┌──────────────────────────────────────────────────────────────┐
    │                🔍 INSPECCIONES                                │
    ├──────────────────────────────────────────────────────────────┤
    │ PK  id_inspeccion                                            │
    │     nombre_inspeccion                                        │
    │     tipo_inspeccion                                          │
    │     edificio, piso, ubicacion                                │
    │                                                              │
    │ ┌──────────────────────────────────────────────────────┐    │
    │ │  CAMPOS ESPECÍFICOS POR TIPO:                        │    │
    │ │                                                       │    │
    │ │  • Cubierta de Techos (lámina, hojalatería, etc.)   │    │
    │ │  • Electricidad (iluminación, tomacorrientes, etc.) │    │
    │ │  • Puertas                                           │    │
    │ │  • Pisos                                             │    │
    │ │  • Pintura                                           │    │
    │ │  • Bombas de Agua                                    │    │
    │ │  • Aire Acondicionado                                │    │
    │ │  • Ventanas                                          │    │
    │ │  • Barandas                                          │    │
    │ │  • Hidro Lavados                                     │    │
    │ │  • Telefonía                                         │    │
    │ │  • Datos                                             │    │
    │ │  • Estructuras de Metal                              │    │
    │ │  • Sistemas Contra Incendios                         │    │
    │ │  • Planta Eléctrica                                  │    │
    │ │  • Motores de Portones                               │    │
    │ │  • Aceras                                            │    │
    │ │  • Cordón + Caño                                     │    │
    │ │  • Cámaras de Seguridad                              │    │
    │ └──────────────────────────────────────────────────────┘    │
    │                                                              │
    │     observaciones                                            │
    │     recomendaciones                                          │
    │ FK  creado_por                                               │
    │     fecha_creacion                                           │
    │     fecha_actualizacion                                      │
    └──────────────────────────────────────────────────────────────┘
              │
              │
              ├─────────────────────────┐
              │                         │
              │ 1:N                     │ 1:N
              │                         │
              ▼                         ▼
    ┌──────────────────────────┐   ┌──────────────────────────┐
    │  🖼️  IMAGENES_INSPECCION │   │      📋 TAREAS          │
    ├──────────────────────────┤   ├──────────────────────────┤
    │ PK  id_imagen            │   │ PK  id_tarea             │
    │ FK  id_inspeccion ───────│─┐ │     titulo               │
    │     nombre_archivo       │ │ │     estado               │
    │     tipo_mime            │ │ │       • No Iniciado 🔴  │
    │     data_base64          │ │ │       • En Proceso 🟡   │
    │     tamaño_bytes         │ │ │       • Finalizado 🟢   │
    │     descripcion          │ │ │     asignado_a           │
    │ FK  subido_por           │ │ │     fecha                │
    │     fecha_subida         │ │ │     prioridad            │
    └──────────────────────────┘ │ │       • Alta 🔴         │
                                 │ │       • Media 🟡        │
                                 │ │       • Baja 🟢         │
                                 │ │     descripcion          │
                                 └─│ FK  id_inspeccion        │
                                   │ FK  creado_por           │
                                   │     fecha_creacion       │
                                   │     fecha_actualizacion  │
                                   └──────────────────────────┘


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔄 FLUJO DE TRABAJO
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. INICIO DE SESIÓN
   ──────────────────

   Usuario ingresa email + password
              │
              ▼
   SP_autenticar_usuario(@email)
              │
              ▼
   Validar password_hash con bcrypt
              │
              ├────────────────────┐
              │                    │
             ✓                    ✗
              │                    │
              ▼                    ▼
      Retornar datos         Error 401
      del usuario +
      rol asignado


2. CREAR INSPECCIÓN
   ─────────────────

   Usuario completa formulario de inspección
   (llena solo los campos del tipo de inspección)
              │
              ▼
   SP_crear_inspeccion(...)
              │
              ▼
   INSERT INTO inspecciones
              │
              ▼
   Retorna id_inspeccion
              │
              ▼
   ¿Hay imágenes para subir?
              │
        ┌─────┴─────┐
        │           │
       SÍ          NO
        │           │
        ▼           │
   Subir imágenes   │
   en base64        │
        │           │
        ▼           ▼
   INSERT INTO      Fin
   imagenes_inspeccion


3. CREAR TAREA
   ────────────

   Usuario crea tarea
   (puede vincular a inspección o no)
              │
              ▼
   SP_crear_tarea(...)
              │
              ▼
   INSERT INTO tareas
   estado = 'No Iniciado'
              │
              ▼
   Retorna id_tarea


4. ACTUALIZAR TAREA
   ─────────────────

   Usuario cambia estado o asignación
              │
              ▼
   SP_actualizar_tarea(...)
              │
              ▼
   UPDATE tareas
   SET estado = nuevo_estado
              │
              ▼
   Trigger TR_tareas_update
   actualiza fecha_actualizacion


5. VISUALIZAR DASHBOARD
   ─────────────────────

   Dashboard solicita estadísticas
              │
              ▼
   SELECT * FROM VW_estadisticas_tareas
              │
              ▼
   Mostrar gráficos:
   • Tareas por estado (gráfica de barras)
   • Tareas por prioridad (gráfica circular)
   • Progreso general


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📝 EJEMPLO DE DATOS - TABLA INSPECCIONES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

INSPECCIÓN DE ELECTRICIDAD:
┌────────────────────────────────────────────────────────────────────┐
│ id_inspeccion: 1                                                   │
│ nombre_inspeccion: "Inspección Eléctrica - Edificio A"            │
│ tipo_inspeccion: "Electricidad"                                   │
│ edificio: "Edificio A"                                             │
│ piso: "Planta Baja"                                                │
│ ubicacion: "Oficina 101"                                           │
│                                                                    │
│ iluminacion_ubicacion: "interna"                                  │
│ iluminacion_bombillo: "LED"                                       │
│ iluminacion_tipo_luz: "luz blanca"                                │
│ iluminacion_watts: 12                                              │
│ iluminacion_apagador_marca: "Leviton"                             │
│ iluminacion_apagador_tipo: "doble"                                │
│                                                                    │
│ tomacorriente_tipo: "doble"                                       │
│ tomacorriente_voltaje: "110v"                                     │
│ tomacorriente_polarizado: 1 (true)                                │
│ tomacorriente_ubicacion: "interno"                                │
│ tomacorriente_seguridad: "GFCI"                                   │
│                                                                    │
│ (todos los demás campos NULL porque no aplican)                   │
│                                                                    │
│ observaciones: "Todo funcionando correctamente"                   │
│ recomendaciones: "Revisar en 3 meses"                             │
│ creado_por: 1                                                      │
└────────────────────────────────────────────────────────────────────┘


INSPECCIÓN DE AIRE ACONDICIONADO:
┌────────────────────────────────────────────────────────────────────┐
│ id_inspeccion: 2                                                   │
│ nombre_inspeccion: "Mantenimiento AC - Sala Principal"            │
│ tipo_inspeccion: "Aire Acondicionado"                             │
│ edificio: "Edificio B"                                             │
│ piso: "Piso 1"                                                     │
│ ubicacion: "Sala de Juntas"                                        │
│                                                                    │
│ ac_tipo: "mini split"                                              │
│ ac_capacidad_btu: 12000                                            │
│ ac_gas_refrigerante: "R410A"                                       │
│ ac_limpieza_filtros: 0 (false - necesita limpieza)                │
│ ac_limpieza_serpentines: 0 (false - necesita limpieza)            │
│ ac_nivel_gas: "Adecuado"                                           │
│ ac_estado_drenaje: "Limpio"                                        │
│ ac_estado_control_remoto: "Funcional"                             │
│ ac_ruido_vibracion: "Sin ruidos anormales"                        │
│ ac_consumo_electrico: "Normal"                                     │
│                                                                    │
│ (todos los demás campos NULL porque no aplican)                   │
│                                                                    │
│ observaciones: "Filtros muy sucios, requiere limpieza urgente"   │
│ recomendaciones: "Limpiar filtros inmediatamente"                 │
│ creado_por: 1                                                      │
└────────────────────────────────────────────────────────────────────┘


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 EJEMPLO DE DATOS - TABLA TAREAS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────┬──────────────────────────────┬──────────────┬──────────────┬────────────┬───────────┐
│ ID  │ Título                       │ Estado       │ Asignado     │ Fecha      │ Prioridad │
├─────┼──────────────────────────────┼──────────────┼──────────────┼────────────┼───────────┤
│ 1   │ Revisar sistema eléctrico    │ No Iniciado  │ Juan Pérez   │ 2025-10-19 │ Alta 🔴  │
│     │ principal                    │     🔴       │              │            │           │
├─────┼──────────────────────────────┼──────────────┼──────────────┼────────────┼───────────┤
│ 2   │ Limpiar filtros de AC        │ En Proceso   │ María        │ 2025-10-19 │ Media 🟡 │
│     │                              │     🟡       │ González     │            │           │
├─────┼──────────────────────────────┼──────────────┼──────────────┼────────────┼───────────┤
│ 3   │ Pintar fachada principal     │ No Iniciado  │ Carlos       │ 2025-10-26 │ Baja 🟢  │
│     │                              │     🔴       │ Rodríguez    │            │           │
├─────┼──────────────────────────────┼──────────────┼──────────────┼────────────┼───────────┤
│ 4   │ Reparar puerta de emergencia │ Finalizado   │ Juan Pérez   │ 2025-10-17 │ Alta 🔴  │
│     │                              │     🟢       │              │            │           │
├─────┼──────────────────────────────┼──────────────┼──────────────┼────────────┼───────────┤
│ 5   │ Mantenimiento bomba de agua  │ En Proceso   │ Carlos       │ 2025-10-19 │ Alta 🔴  │
│     │                              │     🟡       │ Rodríguez    │            │           │
└─────┴──────────────────────────────┴──────────────┴──────────────┴────────────┴───────────┘


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔐 CONTROL DE ACCESO POR ROL
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌────────────────────┬──────────────────────────────────────────────────────────┐
│ ROL                │ PERMISOS                                                 │
├────────────────────┼──────────────────────────────────────────────────────────┤
│ 👑 ADMINISTRADOR   │ • Crear, editar, eliminar usuarios                      │
│                    │ • Crear, editar, eliminar inspecciones                  │
│                    │ • Crear, editar, eliminar tareas                        │
│                    │ • Ver todas las tareas de todos los usuarios            │
│                    │ • Acceso completo al dashboard                          │
│                    │ • Subir y eliminar imágenes                             │
│                    │ • Generar reportes                                       │
├────────────────────┼──────────────────────────────────────────────────────────┤
│ 👤 USUARIO         │ • Ver su perfil                                          │
│                    │ • Crear inspecciones                                     │
│                    │ • Crear tareas                                           │
│                    │ • Editar solo sus propias tareas                         │
│                    │ • Ver solo tareas asignadas a él                         │
│                    │ • Subir imágenes a sus inspecciones                     │
│                    │ • Ver dashboard limitado (solo sus datos)                │
└────────────────────┴──────────────────────────────────────────────────────────┘


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 VISTAS ÚTILES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

VW_tareas_completas
───────────────────
Muestra todas las tareas con información completa incluyendo:
• Datos de la tarea
• Información de la inspección relacionada (si existe)
• Datos del usuario creador
• Conteo de imágenes

Uso: SELECT * FROM VW_tareas_completas WHERE estado = 'En Proceso';


VW_estadisticas_tareas
──────────────────────
Agrupa estadísticas por estado de tarea:
• Total de tareas por estado
• Cantidad de tareas por prioridad en cada estado

Uso: SELECT * FROM VW_estadisticas_tareas;


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔧 PROCEDIMIENTOS ALMACENADOS PRINCIPALES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. SP_autenticar_usuario(@email)
   → Autentica usuario y retorna datos + rol

2. SP_crear_inspeccion(@nombre_inspeccion, @tipo_inspeccion, @creado_por, @id_inspeccion_nueva OUTPUT)
   → Crea nueva inspección y retorna ID

3. SP_crear_tarea(@titulo, @estado, @asignado_a, @fecha, @prioridad, ..., @id_tarea_nueva OUTPUT)
   → Crea nueva tarea y retorna ID

4. SP_actualizar_tarea(@id_tarea, @titulo, @estado, @asignado_a, @fecha, @prioridad, ...)
   → Actualiza tarea existente

5. SP_obtener_tareas()
   → Obtiene todas las tareas ordenadas por estado y prioridad


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚡ TRIGGERS AUTOMÁTICOS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

TR_usuarios_update
   → Actualiza automáticamente fecha_actualizacion en usuarios

TR_inspecciones_update
   → Actualiza automáticamente fecha_actualizacion en inspecciones

TR_tareas_update
   → Actualiza automáticamente fecha_actualizacion en tareas


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 CARACTERÍSTICAS CLAVE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ Sistema de roles separado (tabla dedicada)
✅ Usuarios con nombre, email, teléfono y rol
✅ Inspecciones con campos específicos para 19 tipos diferentes
✅ Imágenes guardadas en base64 relacionadas con inspecciones
✅ Tareas con estados visuales (colores) y prioridades
✅ Relaciones opcionales entre tareas e inspecciones
✅ Triggers automáticos para auditoría
✅ Vistas para consultas complejas
✅ Procedimientos almacenados para operaciones comunes
✅ Índices para optimización de consultas

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Diagrama creado para: Planificador de Mantenimiento V2.0
Fecha: Octubre 2025
Compatible con: SQL Server 2016+

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

